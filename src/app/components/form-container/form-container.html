<form class="flex flex-col gap-4">
  @let form = stipendioForm();
  @let model = formModel()();

  <!-- Sezione Dati Principali -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 dark:bg-stone-800 dark:border-stone-700"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Dati Contrattuali
    </legend>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex flex-col gap-1">
        <label for="ral" class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >RAL *<app-info-tooltip
            tooltipId="ral-info"
            text="Retribuzione Annua Lorda: il compenso totale annuo lordo previsto dal contratto, prima di contributi e imposte."
          />
        </label>
        <input
          id="ral"
          type="number"
          [formField]="form.ral"
          placeholder="Es. 24000"
          aria-required="true"
          [attr.aria-invalid]="form.ral().invalid()"
          [attr.aria-describedby]="form.ral().invalid() ? 'ral-error' : null"
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.ral().invalid()) {
          @for (error of form.ral().errors(); track error.kind) {
            <span id="ral-error" class="text-xs text-red-600 mt-1 dark:text-red-400" role="alert">{{
              error.message
            }}</span>
          }
        }
      </div>

      <div class="flex flex-col gap-1">
        <label for="mensilita" class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Mensilità *<app-info-tooltip
            tooltipId="mensilita-info"
            text="Numero di mensilità annue. La 13a e 14a sono erogate come tredicesima e quattordicesima. La RAL viene divisa per questo numero."
          />
        </label>
        <select
          id="mensilita"
          [formField]="form.mensilita"
          aria-required="true"
          [attr.aria-invalid]="form.mensilita().invalid()"
          [attr.aria-describedby]="form.mensilita().invalid() ? 'mensilita-error' : null"
          class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
        >
          @for (m of mensilita; track m) {
            <option [value]="m">{{ m }}</option>
          }
        </select>
        @if (form.mensilita().invalid()) {
          @for (error of form.mensilita().errors(); track error.kind) {
            <span
              id="mensilita-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1">
        <label
          for="tipoContratto"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Tipo Contratto *<app-info-tooltip
            tooltipId="tipoContratto-info"
            text="Gli apprendisti hanno un'aliquota INPS ridotta (5,84%). I contratti a tempo determinato hanno una detrazione minima garantita inferiore."
          />
        </label>
        <select
          id="tipoContratto"
          [formField]="form.tipoContratto"
          aria-required="true"
          class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
        >
          @for (tipo of tipiContratto; track tipo.value) {
            <option [value]="tipo.value">{{ tipo.label }}</option>
          }
        </select>
      </div>

      <div class="flex flex-col gap-1">
        <label
          for="annoFiscale"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Anno Fiscale *<app-info-tooltip
            tooltipId="annoFiscale-info"
            text="Dal 2026 l'aliquota IRPEF del 2° scaglione scende dal 35% al 33%. Possono variare anche soglie e limiti."
          />
        </label>
        <select
          id="annoFiscale"
          [formField]="form.annoFiscale"
          aria-required="true"
          class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
        >
          @for (anno of anniFiscali; track anno) {
            <option [value]="anno">{{ anno }}</option>
          }
        </select>
      </div>

      <div class="flex flex-col gap-1">
        <label for="regione" class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Regione *<app-info-tooltip
            tooltipId="regione-info"
            text="Determina l'addizionale regionale IRPEF, che varia da 1,23% a 3,33% a seconda della regione e del reddito."
          />
        </label>
        <select
          id="regione"
          [formField]="form.regione"
          aria-required="true"
          [attr.aria-invalid]="form.regione().invalid()"
          [attr.aria-describedby]="form.regione().invalid() ? 'regione-error' : null"
          class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
        >
          @for (regione of regioniDisponibili; track regione.value) {
            <option [value]="regione.value">{{ regione.label }}</option>
          }
        </select>
        @if (form.regione().invalid()) {
          @for (error of form.regione().errors(); track error.kind) {
            <span
              id="regione-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1">
        <label for="comune" class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Comune *<app-info-tooltip
            tooltipId="comune-info"
            text="Determina l'addizionale comunale IRPEF (0-0,8%). Alcuni comuni prevedono esenzioni per redditi bassi."
          />
        </label>
        <select
          id="comune"
          [formField]="form.comune"
          aria-required="true"
          [attr.aria-invalid]="form.comune().invalid()"
          [attr.aria-describedby]="form.comune().invalid() ? 'comune-error' : null"
          class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
        >
          @for (comune of comuniDisponibili; track comune.value) {
            <option [value]="comune.value">{{ comune.label }}</option>
          }
        </select>
        @if (form.comune().invalid()) {
          @for (error of form.comune().errors(); track error.kind) {
            <span
              id="comune-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>
    </div>
  </fieldset>

  <!-- Sezione Opzioni Contrattuali -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 dark:bg-stone-800 dark:border-stone-700"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Opzioni Contrattuali
    </legend>

    <div class="flex flex-col gap-1 mb-4">
      <label
        for="giorniLavorati"
        class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
        >Giorni Lavorati (opzionale)<app-info-tooltip
          tooltipId="giorniLavorati-info"
          text="Le detrazioni lavoro dipendente sono rapportate ai giorni effettivi. Utile per chi non lavora l'intero anno."
        />
      </label>
      <input
        id="giorniLavorati"
        type="number"
        [formField]="form.giorniLavorati"
        placeholder="Default: 365"
        [attr.aria-invalid]="form.giorniLavorati().invalid()"
        [attr.aria-describedby]="form.giorniLavorati().invalid() ? 'giorniLavorati-error' : null"
        class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
      />
      @if (form.giorniLavorati().invalid()) {
        @for (error of form.giorniLavorati().errors(); track error.kind) {
          <span
            id="giorniLavorati-error"
            class="text-xs text-red-600 mt-1 dark:text-red-400"
            role="alert"
            >{{ error.message }}</span
          >
        }
      }
    </div>

    <div class="flex items-center gap-2 mb-3">
      <input
        id="aziendaConCigs"
        type="checkbox"
        [formField]="form.aziendaConCigs"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="aziendaConCigs"
        class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
        >Azienda con più di 15 dipendenti (CIGS)<app-info-tooltip
          tooltipId="aziendaConCigs-info"
          text="CIGS = Cassa Integrazione Guadagni Straordinaria. Le aziende con oltre 15 dipendenti versano un contributo aggiuntivo, portando l'aliquota INPS dal 9,19% al 9,49%."
        />
      </label>
    </div>

    <div class="flex items-center gap-2 mb-3">
      <input
        id="iscrittoPost1996"
        type="checkbox"
        [formField]="form.iscrittoPost1996"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="iscrittoPost1996"
        class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
        >Iscritto alla previdenza dal 1996 in poi<app-info-tooltip
          tooltipId="iscrittoPost1996-info"
          text="Chi si è iscritto alla previdenza dopo il 1995 ha un massimale contributivo di 120.607 euro (2025)."
        />
      </label>
    </div>
  </fieldset>

  <!-- Sezione Altri Redditi e Detrazioni -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 dark:bg-stone-800 dark:border-stone-700"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Altri Redditi e Detrazioni
    </legend>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex flex-col gap-1">
        <label
          for="altriRedditi"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Altri Redditi (€/anno)<app-info-tooltip
            tooltipId="altriRedditi-info"
            text="Redditi non da lavoro dipendente (es. affitti, rendite). Concorrono al reddito complessivo per IRPEF e detrazioni."
          />
        </label>
        <input
          id="altriRedditi"
          type="number"
          [formField]="form.altriRedditi"
          placeholder="Es. redditi fondiari"
          [attr.aria-invalid]="form.altriRedditi().invalid()"
          [attr.aria-describedby]="form.altriRedditi().invalid() ? 'altriRedditi-error' : null"
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.altriRedditi().invalid()) {
          @for (error of form.altriRedditi().errors(); track error.kind) {
            <span
              id="altriRedditi-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1">
        <label
          for="altreDetrazioni"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Altre Detrazioni (€/anno)<app-info-tooltip
            tooltipId="altreDetrazioni-info"
            text="Detrazioni extra non calcolate automaticamente (es. 19% interessi mutuo prima casa, spese mediche, ristrutturazioni)."
          />
        </label>
        <input
          id="altreDetrazioni"
          type="number"
          [formField]="form.altreDetrazioni"
          placeholder="Es. interessi mutuo"
          [attr.aria-invalid]="form.altreDetrazioni().invalid()"
          [attr.aria-describedby]="
            form.altreDetrazioni().invalid() ? 'altreDetrazioni-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.altreDetrazioni().invalid()) {
          @for (error of form.altreDetrazioni().errors(); track error.kind) {
            <span
              id="altreDetrazioni-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>
    </div>
  </fieldset>

  <!-- Sezione Coniuge a Carico -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 transition-opacity duration-200 dark:bg-stone-800 dark:border-stone-700"
    [class.opacity-60]="!model.coniuge.enabled"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Coniuge a Carico
    </legend>

    <div class="flex items-center gap-2 mb-4">
      <input
        id="coniugeEnabled"
        type="checkbox"
        [formField]="form.coniuge.enabled"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="coniugeEnabled"
        class="text-sm text-stone-700 font-medium dark:text-stone-300 flex items-center"
        >Ho un coniuge a carico<app-info-tooltip
          tooltipId="coniugeEnabled-info"
          text="Il coniuge con reddito fino a 2.840,51 euro annui da diritto a una detrazione fiscale da 0 a 800 euro, in base al tuo reddito."
        />
      </label>
    </div>

    @if (model.coniuge.enabled) {
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex flex-col gap-1">
          <label
            for="coniugeReddito"
            class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
            >Reddito annuo coniuge (€)<app-info-tooltip
              tooltipId="coniugeReddito-info"
              text="Limite massimo 2.840,51 euro per essere considerato a carico. Include tutti i redditi, anche quelli esenti."
            />
          </label>
          <input
            id="coniugeReddito"
            type="number"
            [formField]="form.coniuge.redditoAnnuo"
            placeholder="Max €2.840,51 per detrazione"
            [attr.aria-invalid]="form.coniuge.redditoAnnuo().invalid()"
            [attr.aria-describedby]="
              form.coniuge.redditoAnnuo().invalid() ? 'coniugeReddito-error' : null
            "
            class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
          />
          @if (form.coniuge.redditoAnnuo().invalid()) {
            @for (error of form.coniuge.redditoAnnuo().errors(); track error.kind) {
              <span
                id="coniugeReddito-error"
                class="text-xs text-red-600 mt-1 dark:text-red-400"
                role="alert"
                >{{ error.message }}</span
              >
            }
          }
        </div>

        <div class="flex flex-col gap-1">
          <label
            for="coniugePercentuale"
            class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
            >Percentuale a carico (%)<app-info-tooltip
              tooltipId="coniugePercentuale-info"
              text="Di norma 100%, ma in casi particolari la detrazione può essere ripartita."
            />
          </label>
          <input
            id="coniugePercentuale"
            type="number"
            [formField]="form.coniuge.percentualeCarico"
            [attr.aria-invalid]="form.coniuge.percentualeCarico().invalid()"
            [attr.aria-describedby]="
              form.coniuge.percentualeCarico().invalid() ? 'coniugePercentuale-error' : null
            "
            class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
          />
          @if (form.coniuge.percentualeCarico().invalid()) {
            @for (error of form.coniuge.percentualeCarico().errors(); track error.kind) {
              <span
                id="coniugePercentuale-error"
                class="text-xs text-red-600 mt-1 dark:text-red-400"
                role="alert"
                >{{ error.message }}</span
              >
            }
          }
        </div>
      </div>
    }
  </fieldset>

  <!-- Sezione Figli a Carico -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 transition-opacity duration-200 dark:bg-stone-800 dark:border-stone-700"
    [class.opacity-60]="!model.haFigliACarico && model.figli.length === 0"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Figli a Carico
    </legend>

    <div class="flex items-center gap-2 mb-4">
      <input
        id="haFigliACarico"
        type="checkbox"
        [formField]="form.haFigliACarico"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="haFigliACarico"
        class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
        >Ho figli a carico (per soglia fringe benefit)<app-info-tooltip
          tooltipId="haFigliACarico-info"
          text="Chi ha figli a carico beneficia di una soglia fringe benefit raddoppiata: 2.000 euro invece di 1.000 euro."
        />
      </label>
    </div>

    @for (figlio of model.figli; track $index) {
      <div
        class="border border-dashed border-stone-300 rounded-md p-4 mb-3 bg-stone-50/50 dark:border-stone-600 dark:bg-stone-900/50"
      >
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-semibold text-stone-700 dark:text-stone-300">
            Figlio {{ $index + 1 }}
          </h4>
          <button
            type="button"
            (click)="removeFiglio($index)"
            class="p-2 text-red-600 hover:bg-red-50 rounded-md cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 transition-colors dark:text-red-400 dark:hover:bg-red-900/20"
            aria-label="Rimuovi figlio {{ $index + 1 }}"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
          <div class="flex flex-col gap-1">
            <label
              [for]="'figlioEta' + $index"
              class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
              >Età<app-info-tooltip
                [tooltipId]="'figlioEta' + $index + '-info'"
                text="Detrazione IRPEF solo per figli 21-30 anni. Sotto i 21 anni spetta l'Assegno Unico INPS (non calcolato qui)."
              />
            </label>
            <input
              [id]="'figlioEta' + $index"
              type="number"
              [formField]="form.figli[$index].eta"
              [attr.aria-invalid]="form.figli[$index].eta().invalid()"
              [attr.aria-describedby]="
                form.figli[$index].eta().invalid() ? 'figlioEta' + $index + '-error' : null
              "
              class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
            />
            @if (form.figli[$index].eta().invalid()) {
              @for (error of form.figli[$index].eta().errors(); track error.kind) {
                <span
                  [id]="'figlioEta' + $index + '-error'"
                  class="text-xs text-red-600 mt-1 dark:text-red-400"
                  role="alert"
                  >{{ error.message }}</span
                >
              }
            }
          </div>

          <div class="flex flex-col gap-1">
            <label
              [for]="'figlioPercentuale' + $index"
              class="text-sm text-stone-600 dark:text-stone-400"
              >Percentuale a carico (%)</label
            >
            <input
              [id]="'figlioPercentuale' + $index"
              type="number"
              [formField]="form.figli[$index].percentualeCarico"
              [attr.aria-invalid]="form.figli[$index].percentualeCarico().invalid()"
              [attr.aria-describedby]="
                form.figli[$index].percentualeCarico().invalid()
                  ? 'figlioPercentuale' + $index + '-error'
                  : null
              "
              class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
            />
            @if (form.figli[$index].percentualeCarico().invalid()) {
              @for (error of form.figli[$index].percentualeCarico().errors(); track error.kind) {
                <span
                  [id]="'figlioPercentuale' + $index + '-error'"
                  class="text-xs text-red-600 mt-1 dark:text-red-400"
                  role="alert"
                  >{{ error.message }}</span
                >
              }
            }
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input
            [id]="'figlioDisabile' + $index"
            type="checkbox"
            [formField]="form.figli[$index].disabile"
            class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
          />
          <label
            [for]="'figlioDisabile' + $index"
            class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
            >Disabile<app-info-tooltip
              [tooltipId]="'figlioDisabile' + $index + '-info'"
              text="I figli disabili danno diritto alla detrazione fiscale a qualsiasi età, non solo tra 21 e 30 anni."
            />
          </label>
        </div>
      </div>
    }

    <button
      type="button"
      (click)="addFiglio()"
      class="px-4 py-2 text-sm font-medium border border-stone-400 rounded-md bg-stone-100 text-stone-700 cursor-pointer hover:bg-stone-200 hover:border-stone-500 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:ring-offset-2 transition-colors dark:bg-stone-600 dark:border-stone-500 dark:text-stone-100 dark:hover:bg-stone-500"
    >
      Aggiungi figlio
    </button>
  </fieldset>

  <!-- Sezione Ascendenti a Carico -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 transition-opacity duration-200 dark:bg-stone-800 dark:border-stone-700"
    [class.opacity-60]="model.ascendenti.length === 0"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Ascendenti a Carico (genitori/nonni)
    </legend>

    @for (ascendente of model.ascendenti; track $index) {
      <div
        class="border border-dashed border-stone-300 rounded-md p-4 mb-3 bg-stone-50/50 dark:border-stone-600 dark:bg-stone-900/50"
      >
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-semibold text-stone-700 dark:text-stone-300">
            Ascendente {{ $index + 1 }}
          </h4>
          <button
            type="button"
            (click)="removeAscendente($index)"
            class="p-2 text-red-600 hover:bg-red-50 rounded-md cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 transition-colors dark:text-red-400 dark:hover:bg-red-900/20"
            aria-label="Rimuovi ascendente {{ $index + 1 }}"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <div class="flex flex-col gap-1 mb-3">
          <label
            [for]="'ascendenteReddito' + $index"
            class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
            >Reddito annuo (€)<app-info-tooltip
              [tooltipId]="'ascendenteReddito' + $index + '-info'"
              text="Limite massimo 2.840,51 euro per essere a carico. La detrazione massima è 750 euro e decresce col reddito."
            />
          </label>
          <input
            [id]="'ascendenteReddito' + $index"
            type="number"
            [formField]="form.ascendenti[$index].redditoAnnuo"
            [attr.aria-invalid]="form.ascendenti[$index].redditoAnnuo().invalid()"
            [attr.aria-describedby]="
              form.ascendenti[$index].redditoAnnuo().invalid()
                ? 'ascendenteReddito' + $index + '-error'
                : null
            "
            class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
          />
          @if (form.ascendenti[$index].redditoAnnuo().invalid()) {
            @for (error of form.ascendenti[$index].redditoAnnuo().errors(); track error.kind) {
              <span
                [id]="'ascendenteReddito' + $index + '-error'"
                class="text-xs text-red-600 mt-1 dark:text-red-400"
                role="alert"
                >{{ error.message }}</span
              >
            }
          }
        </div>

        <div class="flex items-center gap-2">
          <input
            [id]="'ascendenteConvivente' + $index"
            type="checkbox"
            [formField]="form.ascendenti[$index].convivente"
            class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
          />
          <label
            [for]="'ascendenteConvivente' + $index"
            class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
            >Convivente<app-info-tooltip
              [tooltipId]="'ascendenteConvivente' + $index + '-info'"
              text="La detrazione per ascendenti spetta solo se conviventi. Richiesta residenza nello stesso nucleo familiare."
            />
          </label>
        </div>
      </div>
    }

    <button
      type="button"
      (click)="addAscendente()"
      class="px-4 py-2 text-sm font-medium border border-stone-400 rounded-md bg-stone-100 text-stone-700 cursor-pointer hover:bg-stone-200 hover:border-stone-500 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:ring-offset-2 transition-colors dark:bg-stone-600 dark:border-stone-500 dark:text-stone-100 dark:hover:bg-stone-500"
    >
      Aggiungi ascendente
    </button>
  </fieldset>

  <!-- Sezione Fringe Benefit -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 transition-opacity duration-200 dark:bg-stone-800 dark:border-stone-700"
    [class.opacity-60]="!model.fringeBenefit.enabled"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Fringe Benefit
    </legend>

    <div class="flex items-center gap-2 mb-4">
      <input
        id="fringeBenefitEnabled"
        type="checkbox"
        [formField]="form.fringeBenefit.enabled"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="fringeBenefitEnabled"
        class="text-sm text-stone-700 font-medium dark:text-stone-300 flex items-center"
        >Ho fringe benefit<app-info-tooltip
          tooltipId="fringeBenefitEnabled-info"
          text="Compensi in natura. Esenti fino a 1.000 euro (2.000 con figli, 5.000 neoassunti). ATTENZIONE: sistema a soglia secca - se superi anche di 1 centesimo, tutto diventa imponibile!"
        />
      </label>
    </div>

    @if (model.fringeBenefit.enabled) {
      <div class="flex flex-col gap-1 mb-4">
        <label
          for="buoniAcquisto"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Buoni acquisto/spesa (€/anno)<app-info-tooltip
            tooltipId="buoniAcquisto-info"
            text="Buoni spendibili per acquisti. Concorrono alla soglia fringe benefit complessiva."
          />
        </label>
        <input
          id="buoniAcquisto"
          type="number"
          [formField]="form.fringeBenefit.buoniAcquisto"
          [attr.aria-invalid]="form.fringeBenefit.buoniAcquisto().invalid()"
          [attr.aria-describedby]="
            form.fringeBenefit.buoniAcquisto().invalid() ? 'buoniAcquisto-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.fringeBenefit.buoniAcquisto().invalid()) {
          @for (error of form.fringeBenefit.buoniAcquisto().errors(); track error.kind) {
            <span
              id="buoniAcquisto-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="buoniCarburante" class="text-sm text-stone-600 dark:text-stone-400"
          >Buoni carburante (€/anno)</label
        >
        <input
          id="buoniCarburante"
          type="number"
          [formField]="form.fringeBenefit.buoniCarburante"
          [attr.aria-invalid]="form.fringeBenefit.buoniCarburante().invalid()"
          [attr.aria-describedby]="
            form.fringeBenefit.buoniCarburante().invalid() ? 'buoniCarburante-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.fringeBenefit.buoniCarburante().invalid()) {
          @for (error of form.fringeBenefit.buoniCarburante().errors(); track error.kind) {
            <span
              id="buoniCarburante-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoUtenze" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso utenze domestiche (€/anno)</label
        >
        <input
          id="rimborsoUtenze"
          type="number"
          [formField]="form.fringeBenefit.rimborsoUtenze"
          [attr.aria-invalid]="form.fringeBenefit.rimborsoUtenze().invalid()"
          [attr.aria-describedby]="
            form.fringeBenefit.rimborsoUtenze().invalid() ? 'rimborsoUtenze-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.fringeBenefit.rimborsoUtenze().invalid()) {
          @for (error of form.fringeBenefit.rimborsoUtenze().errors(); track error.kind) {
            <span
              id="rimborsoUtenze-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoAffitto" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso affitto prima casa (€/anno)</label
        >
        <input
          id="rimborsoAffitto"
          type="number"
          [formField]="form.fringeBenefit.rimborsoAffitto"
          [attr.aria-invalid]="form.fringeBenefit.rimborsoAffitto().invalid()"
          [attr.aria-describedby]="
            form.fringeBenefit.rimborsoAffitto().invalid() ? 'rimborsoAffitto-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.fringeBenefit.rimborsoAffitto().invalid()) {
          @for (error of form.fringeBenefit.rimborsoAffitto().errors(); track error.kind) {
            <span
              id="rimborsoAffitto-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoInteressiMutuo" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso interessi mutuo (€/anno)</label
        >
        <input
          id="rimborsoInteressiMutuo"
          type="number"
          [formField]="form.fringeBenefit.rimborsoInteressiMutuo"
          [attr.aria-invalid]="form.fringeBenefit.rimborsoInteressiMutuo().invalid()"
          [attr.aria-describedby]="
            form.fringeBenefit.rimborsoInteressiMutuo().invalid()
              ? 'rimborsoInteressiMutuo-error'
              : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.fringeBenefit.rimborsoInteressiMutuo().invalid()) {
          @for (error of form.fringeBenefit.rimborsoInteressiMutuo().errors(); track error.kind) {
            <span
              id="rimborsoInteressiMutuo-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="fringeBenefitAltri" class="text-sm text-stone-600 dark:text-stone-400"
          >Altri fringe benefit (€/anno)</label
        >
        <input
          id="fringeBenefitAltri"
          type="number"
          [formField]="form.fringeBenefit.altri"
          [attr.aria-invalid]="form.fringeBenefit.altri().invalid()"
          [attr.aria-describedby]="
            form.fringeBenefit.altri().invalid() ? 'fringeBenefitAltri-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.fringeBenefit.altri().invalid()) {
          @for (error of form.fringeBenefit.altri().errors(); track error.kind) {
            <span
              id="fringeBenefitAltri-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <!-- Auto Aziendale -->
      <div class="flex items-center gap-2 mb-4">
        <input
          id="autoAziendaleEnabled"
          type="checkbox"
          [formField]="form.fringeBenefit.autoAziendaleEnabled"
          class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
        />
        <label
          for="autoAziendaleEnabled"
          class="text-sm text-stone-700 font-medium dark:text-stone-300 flex items-center"
          >Ho auto aziendale<app-info-tooltip
            tooltipId="autoAziendaleEnabled-info"
            text="Il valore si calcola: (costo ACI x 15.000 km x percentuale) x mesi/12. Non rientra nella soglia fringe benefit."
          />
        </label>
      </div>

      @if (model.fringeBenefit.autoAziendaleEnabled) {
        <div
          class="border border-dashed border-stone-300 rounded-md p-4 bg-stone-50/50 dark:border-stone-600 dark:bg-stone-900/50"
        >
          <h4 class="text-sm font-semibold text-stone-700 mb-3 dark:text-stone-300">
            Auto Aziendale
          </h4>

          <div class="flex flex-col gap-1 mb-3">
            <label
              for="costoKmAci"
              class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
              >Costo km ACI (€/km)<app-info-tooltip
                tooltipId="costoKmAci-info"
                text="Tariffa ufficiale ACI per il modello di auto. Consultare le tabelle ACI pubblicate annualmente. Inserisci le cifre decimali dopo la virgola (es. 0,03)"
              />
            </label>
            <input
              id="costoKmAci"
              type="number"
              [formField]="form.fringeBenefit.autoAziendale.costoKmAci"
              [attr.aria-invalid]="form.fringeBenefit.autoAziendale.costoKmAci().invalid()"
              [attr.aria-describedby]="
                form.fringeBenefit.autoAziendale.costoKmAci().invalid() ? 'costoKmAci-error' : null
              "
              class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
            />
            @if (form.fringeBenefit.autoAziendale.costoKmAci().invalid()) {
              @for (
                error of form.fringeBenefit.autoAziendale.costoKmAci().errors();
                track error.kind
              ) {
                <span
                  id="costoKmAci-error"
                  class="text-xs text-red-600 mt-1 dark:text-red-400"
                  role="alert"
                  >{{ error.message }}</span
                >
              }
            }
          </div>

          <div class="flex flex-col gap-1 mb-3">
            <label
              for="tipoAlimentazione"
              class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
              >Tipo alimentazione<app-info-tooltip
                tooltipId="tipoAlimentazione-info"
                text="Dal 2025: elettrico 10%, ibrido plug-in 20%, altri 50%. Per auto assegnate prima del 2025 si usa il regime CO2."
              />
            </label>
            <select
              id="tipoAlimentazione"
              [formField]="form.fringeBenefit.autoAziendale.tipoAlimentazione"
              class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
            >
              @for (tipo of tipiAlimentazione; track tipo.value) {
                <option [value]="tipo.value">{{ tipo.label }}</option>
              }
            </select>
          </div>

          <div class="flex flex-col gap-1 mb-3">
            <label for="mesiUtilizzo" class="text-sm text-stone-600 dark:text-stone-400"
              >Mesi di utilizzo</label
            >
            <input
              id="mesiUtilizzo"
              type="number"
              [formField]="form.fringeBenefit.autoAziendale.mesiUtilizzo"
              [attr.aria-invalid]="form.fringeBenefit.autoAziendale.mesiUtilizzo().invalid()"
              [attr.aria-describedby]="
                form.fringeBenefit.autoAziendale.mesiUtilizzo().invalid()
                  ? 'mesiUtilizzo-error'
                  : null
              "
              class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
            />
            @if (form.fringeBenefit.autoAziendale.mesiUtilizzo().invalid()) {
              @for (
                error of form.fringeBenefit.autoAziendale.mesiUtilizzo().errors();
                track error.kind
              ) {
                <span
                  id="mesiUtilizzo-error"
                  class="text-xs text-red-600 mt-1 dark:text-red-400"
                  role="alert"
                  >{{ error.message }}</span
                >
              }
            }
          </div>

          <div class="flex flex-col gap-1 mb-3">
            <label
              for="trattenutaDipendente"
              class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
              >Trattenuta dipendente (€/anno)<app-info-tooltip
                tooltipId="trattenutaDipendente-info"
                text="Importo eventualmente trattenuto in busta paga per l'uso personale dell'auto. Riduce il fringe benefit imponibile."
              />
            </label>
            <input
              id="trattenutaDipendente"
              type="number"
              [formField]="form.fringeBenefit.autoAziendale.trattenutaDipendente"
              [attr.aria-invalid]="
                form.fringeBenefit.autoAziendale.trattenutaDipendente().invalid()
              "
              [attr.aria-describedby]="
                form.fringeBenefit.autoAziendale.trattenutaDipendente().invalid()
                  ? 'trattenutaDipendente-error'
                  : null
              "
              class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
            />
            @if (form.fringeBenefit.autoAziendale.trattenutaDipendente().invalid()) {
              @for (
                error of form.fringeBenefit.autoAziendale.trattenutaDipendente().errors();
                track error.kind
              ) {
                <span
                  id="trattenutaDipendente-error"
                  class="text-xs text-red-600 mt-1 dark:text-red-400"
                  role="alert"
                  >{{ error.message }}</span
                >
              }
            }
          </div>

          <div class="flex items-center gap-2 mb-3">
            <input
              id="assegnatoPre2025"
              type="checkbox"
              [formField]="form.fringeBenefit.autoAziendale.assegnatoPre2025"
              class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
            />
            <label
              for="assegnatoPre2025"
              class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
              >Assegnato prima del 2025 (regime CO2)<app-info-tooltip
                tooltipId="assegnatoPre2025-info"
                text="Le auto assegnate prima del 2025 usano il vecchio regime basato su emissioni CO2: fino a 60 g/km 25%, 61-160 g/km 30%, 161-190 g/km 50%, oltre 60%."
              />
            </label>
          </div>

          @if (model.fringeBenefit.autoAziendale.assegnatoPre2025) {
            <div class="flex flex-col gap-1">
              <label for="emissioniCO2" class="text-sm text-stone-600 dark:text-stone-400"
                >Emissioni CO2 (g/km)</label
              >
              <input
                id="emissioniCO2"
                type="number"
                [formField]="form.fringeBenefit.autoAziendale.emissioniCO2"
                [attr.aria-invalid]="form.fringeBenefit.autoAziendale.emissioniCO2().invalid()"
                [attr.aria-describedby]="
                  form.fringeBenefit.autoAziendale.emissioniCO2().invalid()
                    ? 'emissioniCO2-error'
                    : null
                "
                class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
              />
              @if (form.fringeBenefit.autoAziendale.emissioniCO2().invalid()) {
                @for (
                  error of form.fringeBenefit.autoAziendale.emissioniCO2().errors();
                  track error.kind
                ) {
                  <span
                    id="emissioniCO2-error"
                    class="text-xs text-red-600 mt-1 dark:text-red-400"
                    role="alert"
                    >{{ error.message }}</span
                  >
                }
              }
            </div>
          }
        </div>
      }
    }
  </fieldset>

  <!-- Sezione Rimborsi Trasferta -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 transition-opacity duration-200 dark:bg-stone-800 dark:border-stone-700"
    [class.opacity-60]="!model.rimborsiTrasferta.enabled"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Rimborsi Trasferta
    </legend>

    <div class="flex items-center gap-2 mb-4">
      <input
        id="rimborsiTrasfertaEnabled"
        type="checkbox"
        [formField]="form.rimborsiTrasferta.enabled"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="rimborsiTrasfertaEnabled"
        class="text-sm text-stone-700 font-medium dark:text-stone-300 flex items-center"
        >Ho rimborsi trasferta<app-info-tooltip
          tooltipId="rimborsiTrasfertaEnabled-info"
          text="Rimborsi per trasferte fuori dal comune di lavoro. Possono essere forfettari (46,48 euro/giorno Italia, 77,47 euro estero) o a pie' di lista."
        />
      </label>
    </div>

    @if (model.rimborsiTrasferta.enabled) {
      <div class="flex flex-col gap-1 mb-4">
        <label
          for="modalitaRimborso"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Modalità rimborso<app-info-tooltip
            tooltipId="modalitaRimborso-info"
            text="Forfettario: indennità fissa giornaliera. Analitico: rimborso a pie' di lista documentato. Misto: forfettario ridotto + rimborso vitto/alloggio."
          />
        </label>
        <select
          id="modalitaRimborso"
          [formField]="form.rimborsiTrasferta.modalitaRimborso"
          class="h-[42px] px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100"
        >
          @for (modalita of modalitaRimborso; track modalita.value) {
            <option [value]="modalita.value">{{ modalita.label }}</option>
          }
        </select>
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="giorniTrasfertaItalia" class="text-sm text-stone-600 dark:text-stone-400"
          >Giorni trasferta Italia</label
        >
        <input
          id="giorniTrasfertaItalia"
          type="number"
          [formField]="form.rimborsiTrasferta.giorniTrasfertaItalia"
          [attr.aria-invalid]="form.rimborsiTrasferta.giorniTrasfertaItalia().invalid()"
          [attr.aria-describedby]="
            form.rimborsiTrasferta.giorniTrasfertaItalia().invalid()
              ? 'giorniTrasfertaItalia-error'
              : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.rimborsiTrasferta.giorniTrasfertaItalia().invalid()) {
          @for (
            error of form.rimborsiTrasferta.giorniTrasfertaItalia().errors();
            track error.kind
          ) {
            <span
              id="giorniTrasfertaItalia-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="giorniTrasfertaEstero" class="text-sm text-stone-600 dark:text-stone-400"
          >Giorni trasferta Estero</label
        >
        <input
          id="giorniTrasfertaEstero"
          type="number"
          [formField]="form.rimborsiTrasferta.giorniTrasfertaEstero"
          [attr.aria-invalid]="form.rimborsiTrasferta.giorniTrasfertaEstero().invalid()"
          [attr.aria-describedby]="
            form.rimborsiTrasferta.giorniTrasfertaEstero().invalid()
              ? 'giorniTrasfertaEstero-error'
              : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.rimborsiTrasferta.giorniTrasfertaEstero().invalid()) {
          @for (
            error of form.rimborsiTrasferta.giorniTrasfertaEstero().errors();
            track error.kind
          ) {
            <span
              id="giorniTrasfertaEstero-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoVitto" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso vitto documentato (€/anno)</label
        >
        <input
          id="rimborsoVitto"
          type="number"
          [formField]="form.rimborsiTrasferta.rimborsoVitto"
          [attr.aria-invalid]="form.rimborsiTrasferta.rimborsoVitto().invalid()"
          [attr.aria-describedby]="
            form.rimborsiTrasferta.rimborsoVitto().invalid() ? 'rimborsoVitto-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.rimborsiTrasferta.rimborsoVitto().invalid()) {
          @for (error of form.rimborsiTrasferta.rimborsoVitto().errors(); track error.kind) {
            <span
              id="rimborsoVitto-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoAlloggio" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso alloggio documentato (€/anno)</label
        >
        <input
          id="rimborsoAlloggio"
          type="number"
          [formField]="form.rimborsiTrasferta.rimborsoAlloggio"
          [attr.aria-invalid]="form.rimborsiTrasferta.rimborsoAlloggio().invalid()"
          [attr.aria-describedby]="
            form.rimborsiTrasferta.rimborsoAlloggio().invalid() ? 'rimborsoAlloggio-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.rimborsiTrasferta.rimborsoAlloggio().invalid()) {
          @for (error of form.rimborsiTrasferta.rimborsoAlloggio().errors(); track error.kind) {
            <span
              id="rimborsoAlloggio-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoViaggio" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso viaggio (€/anno)</label
        >
        <input
          id="rimborsoViaggio"
          type="number"
          [formField]="form.rimborsiTrasferta.rimborsoViaggio"
          [attr.aria-invalid]="form.rimborsiTrasferta.rimborsoViaggio().invalid()"
          [attr.aria-describedby]="
            form.rimborsiTrasferta.rimborsoViaggio().invalid() ? 'rimborsoViaggio-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.rimborsiTrasferta.rimborsoViaggio().invalid()) {
          @for (error of form.rimborsiTrasferta.rimborsoViaggio().errors(); track error.kind) {
            <span
              id="rimborsoViaggio-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="rimborsoKm" class="text-sm text-stone-600 dark:text-stone-400"
          >Rimborso chilometrico (€/anno)</label
        >
        <input
          id="rimborsoKm"
          type="number"
          [formField]="form.rimborsiTrasferta.rimborsoKm"
          [attr.aria-invalid]="form.rimborsiTrasferta.rimborsoKm().invalid()"
          [attr.aria-describedby]="
            form.rimborsiTrasferta.rimborsoKm().invalid() ? 'rimborsoKm-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.rimborsiTrasferta.rimborsoKm().invalid()) {
          @for (error of form.rimborsiTrasferta.rimborsoKm().errors(); track error.kind) {
            <span
              id="rimborsoKm-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex items-center gap-2">
        <input
          id="pagamentiTracciabili"
          type="checkbox"
          [formField]="form.rimborsiTrasferta.pagamentiTracciabili"
          class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
        />
        <label
          for="pagamentiTracciabili"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Pagamenti tracciabili<app-info-tooltip
            tooltipId="pagamentiTracciabili-info"
            text="Dal 2025 obbligo di tracciabilità per vitto, alloggio e taxi. Senza tracciabilità i rimborsi diventano imponibili."
          />
        </label>
      </div>
    }
  </fieldset>

  <!-- Sezione Benefit Non Tassati (Welfare) -->
  <fieldset
    class="bg-white border border-stone-200 rounded-lg p-5 transition-opacity duration-200 dark:bg-stone-800 dark:border-stone-700"
    [class.opacity-60]="!model.benefitNonTassati.enabled"
  >
    <legend class="px-2 text-sm font-semibold text-stone-800 dark:text-stone-200">
      Benefit Non Tassati (Welfare)
    </legend>

    <div class="flex items-center gap-2 mb-4">
      <input
        id="benefitNonTassatiEnabled"
        type="checkbox"
        [formField]="form.benefitNonTassati.enabled"
        class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
      />
      <label
        for="benefitNonTassatiEnabled"
        class="text-sm text-stone-700 font-medium dark:text-stone-300 flex items-center"
        >Ho benefit non tassati<app-info-tooltip
          tooltipId="benefitNonTassatiEnabled-info"
          text="Voci welfare completamente esenti o con limiti specifici: previdenza, sanità, buoni pasto, trasporto pubblico, servizi familiari."
        />
      </label>
    </div>

    @if (model.benefitNonTassati.enabled) {
      <div class="flex flex-col gap-1 mb-4">
        <label
          for="previdenzaComplementare"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Previdenza complementare (€/anno)<app-info-tooltip
            tooltipId="previdenzaComplementare-info"
            text="Contributi a fondi pensione. Esenti fino a 5.164,57 euro/anno. Riducono l'imponibile fiscale."
          />
        </label>
        <input
          id="previdenzaComplementare"
          type="number"
          [formField]="form.benefitNonTassati.previdenzaComplementare"
          placeholder="Max €5.164,57 esente"
          [attr.aria-invalid]="form.benefitNonTassati.previdenzaComplementare().invalid()"
          [attr.aria-describedby]="
            form.benefitNonTassati.previdenzaComplementare().invalid()
              ? 'previdenzaComplementare-error'
              : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.benefitNonTassati.previdenzaComplementare().invalid()) {
          @for (
            error of form.benefitNonTassati.previdenzaComplementare().errors();
            track error.kind
          ) {
            <span
              id="previdenzaComplementare-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label
          for="assistenzaSanitaria"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Assistenza sanitaria (€/anno)<app-info-tooltip
            tooltipId="assistenzaSanitaria-info"
            text="Contributi a casse/fondi sanitari integrativi. Esenti fino a 3.615,20 euro/anno."
          />
        </label>
        <input
          id="assistenzaSanitaria"
          type="number"
          [formField]="form.benefitNonTassati.assistenzaSanitaria"
          placeholder="Max €3.615,20 esente"
          [attr.aria-invalid]="form.benefitNonTassati.assistenzaSanitaria().invalid()"
          [attr.aria-describedby]="
            form.benefitNonTassati.assistenzaSanitaria().invalid()
              ? 'assistenzaSanitaria-error'
              : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.benefitNonTassati.assistenzaSanitaria().invalid()) {
          @for (error of form.benefitNonTassati.assistenzaSanitaria().errors(); track error.kind) {
            <span
              id="assistenzaSanitaria-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label for="buoniPasto" class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Buoni pasto (€/anno)<app-info-tooltip
            tooltipId="buoniPasto-info"
            text="Esenti fino a 4 euro/giorno (cartacei) o 8 euro/giorno (elettronici, 10 euro dal 2026). L'eccedenza è imponibile."
          />
        </label>
        <input
          id="buoniPasto"
          type="number"
          [formField]="form.benefitNonTassati.buoniPasto"
          [attr.aria-invalid]="form.benefitNonTassati.buoniPasto().invalid()"
          [attr.aria-describedby]="
            form.benefitNonTassati.buoniPasto().invalid() ? 'buoniPasto-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.benefitNonTassati.buoniPasto().invalid()) {
          @for (error of form.benefitNonTassati.buoniPasto().errors(); track error.kind) {
            <span
              id="buoniPasto-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex items-center gap-2 mb-4">
        <input
          id="buoniPastoElettronici"
          type="checkbox"
          [formField]="form.benefitNonTassati.buoniPastoElettronici"
          class="w-4 h-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500 focus:ring-offset-0 dark:border-stone-600 dark:bg-stone-700 dark:checked:bg-stone-500"
        />
        <label
          for="buoniPastoElettronici"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Buoni pasto elettronici (soglia 8 euro invece di 4 euro)<app-info-tooltip
            tooltipId="buoniPastoElettronici-info"
            text="I buoni elettronici hanno soglia di esenzione doppia. Sono tracciabili e preferiti dal fisco."
          />
        </label>
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label
          for="abbonamentoTrasporto"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Abbonamento trasporto pubblico (€/anno)<app-info-tooltip
            tooltipId="abbonamentoTrasporto-info"
            text="Rimborso o erogazione diretta di abbonamenti TPL. Completamente esente, senza limiti di importo."
          />
        </label>
        <input
          id="abbonamentoTrasporto"
          type="number"
          [formField]="form.benefitNonTassati.abbonamentoTrasporto"
          [attr.aria-invalid]="form.benefitNonTassati.abbonamentoTrasporto().invalid()"
          [attr.aria-describedby]="
            form.benefitNonTassati.abbonamentoTrasporto().invalid()
              ? 'abbonamentoTrasporto-error'
              : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.benefitNonTassati.abbonamentoTrasporto().invalid()) {
          @for (error of form.benefitNonTassati.abbonamentoTrasporto().errors(); track error.kind) {
            <span
              id="abbonamentoTrasporto-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1 mb-4">
        <label
          for="serviziWelfare"
          class="text-sm text-stone-600 dark:text-stone-400 flex items-center"
          >Servizi welfare (€/anno)<app-info-tooltip
            tooltipId="serviziWelfare-info"
            text="Asili nido, borse di studio, colonie estive, assistenza anziani, ecc. Completamente esenti se erogati alla generalità dei dipendenti."
          />
        </label>
        <input
          id="serviziWelfare"
          type="number"
          [formField]="form.benefitNonTassati.serviziWelfare"
          placeholder="Asili, borse studio, ecc."
          [attr.aria-invalid]="form.benefitNonTassati.serviziWelfare().invalid()"
          [attr.aria-describedby]="
            form.benefitNonTassati.serviziWelfare().invalid() ? 'serviziWelfare-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.benefitNonTassati.serviziWelfare().invalid()) {
          @for (error of form.benefitNonTassati.serviziWelfare().errors(); track error.kind) {
            <span
              id="serviziWelfare-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>

      <div class="flex flex-col gap-1">
        <label for="benefitNonTassatiAltri" class="text-sm text-stone-600 dark:text-stone-400"
          >Altri benefit non tassati (€/anno)</label
        >
        <input
          id="benefitNonTassatiAltri"
          type="number"
          [formField]="form.benefitNonTassati.altri"
          [attr.aria-invalid]="form.benefitNonTassati.altri().invalid()"
          [attr.aria-describedby]="
            form.benefitNonTassati.altri().invalid() ? 'benefitNonTassatiAltri-error' : null
          "
          class="px-3 py-2 border border-stone-300 rounded-md text-stone-900 bg-white placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent aria-[invalid=true]:border-red-500 aria-[invalid=true]:focus:ring-red-500 dark:bg-stone-700 dark:border-stone-600 dark:text-stone-100 dark:placeholder:text-stone-500"
        />
        @if (form.benefitNonTassati.altri().invalid()) {
          @for (error of form.benefitNonTassati.altri().errors(); track error.kind) {
            <span
              id="benefitNonTassatiAltri-error"
              class="text-xs text-red-600 mt-1 dark:text-red-400"
              role="alert"
              >{{ error.message }}</span
            >
          }
        }
      </div>
    }
  </fieldset>
</form>
