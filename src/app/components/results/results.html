<aside
  class="bg-white border border-stone-200 rounded-lg overflow-hidden lg:sticky lg:top-20 lg:max-h-[calc(100vh-6rem)] flex flex-col dark:bg-stone-800 dark:border-stone-700"
>
  @if (hasResult()) {
    @let r = result()!;

    <!-- Header con risultati principali -->
    <header
      class="bg-stone-100 border-b border-stone-200 p-6 dark:bg-stone-900 dark:border-stone-700"
    >
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="flex flex-col gap-1">
          <span class="text-sm text-stone-500 dark:text-stone-400">{{
            displayMode.isPercepito() ? 'Percepito Mensile' : 'Netto Mensile'
          }}</span>
          <span class="text-3xl font-bold tracking-tight text-stone-900 dark:text-stone-100">{{
            formatCurrency(displayMode.isPercepito() ? r.nettoMensilePercepito : r.nettoMensile)
          }}</span>
          <span class="text-xs text-stone-400">su {{ r.mensilita }} mensilità</span>
        </div>
        <div class="flex flex-col gap-1 sm:items-end">
          <span class="text-sm text-stone-500 dark:text-stone-400">{{
            displayMode.isPercepito() ? 'Totale Percepito Annuo' : 'Netto Annuo'
          }}</span>
          <span class="text-3xl font-bold tracking-tight text-stone-900 dark:text-stone-100">{{
            formatCurrency(displayMode.isPercepito() ? r.totalePercepito : r.nettoAnnuo)
          }}</span>
          <span class="text-xs text-stone-400">{{
            displayMode.isPercepito() ? '(netto + rimborsi + benefit esenti)' : '(stipendio netto)'
          }}</span>
        </div>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav
      class="flex border-b border-stone-200 dark:border-stone-700"
      role="tablist"
      aria-label="Visualizzazione risultati"
    >
      <button
        type="button"
        role="tab"
        [attr.aria-selected]="activeTab() === 'cedolino'"
        [attr.aria-controls]="'panel-cedolino'"
        [class]="
          activeTab() === 'cedolino'
            ? 'cursor-pointer flex-1 px-4 py-3 text-sm font-medium text-stone-900 bg-white border-b-2 border-stone-900 dark:text-stone-100 dark:bg-stone-800 dark:border-stone-100'
            : 'cursor-pointer flex-1 px-4 py-3 text-sm font-medium text-stone-500 bg-stone-50 hover:text-stone-700 hover:bg-stone-100 dark:text-stone-400 dark:bg-stone-900 dark:hover:text-stone-300 dark:hover:bg-stone-800'
        "
        (click)="setActiveTab('cedolino')"
      >
        Riepilogo
      </button>
      <button
        type="button"
        role="tab"
        [attr.aria-selected]="activeTab() === 'flusso'"
        [attr.aria-controls]="'panel-flusso'"
        [class]="
          activeTab() === 'flusso'
            ? 'cursor-pointer flex-1 px-4 py-3 text-sm font-medium text-stone-900 bg-white border-b-2 border-stone-900 dark:text-stone-100 dark:bg-stone-800 dark:border-stone-100'
            : 'cursor-pointer flex-1 px-4 py-3 text-sm font-medium text-stone-500 bg-stone-50 hover:text-stone-700 hover:bg-stone-100 dark:text-stone-400 dark:bg-stone-900 dark:hover:text-stone-300 dark:hover:bg-stone-800'
        "
        (click)="setActiveTab('flusso')"
      >
        Flusso
      </button>
      <button
        type="button"
        role="tab"
        [attr.aria-selected]="activeTab() === 'proiezione'"
        [attr.aria-controls]="'panel-proiezione'"
        [class]="
          activeTab() === 'proiezione'
            ? 'cursor-pointer flex-1 px-4 py-3 text-sm font-medium text-stone-900 bg-white border-b-2 border-stone-900 dark:text-stone-100 dark:bg-stone-800 dark:border-stone-100'
            : 'cursor-pointer flex-1 px-4 py-3 text-sm font-medium text-stone-500 bg-stone-50 hover:text-stone-700 hover:bg-stone-100 dark:text-stone-400 dark:bg-stone-900 dark:hover:text-stone-300 dark:hover:bg-stone-800'
        "
        (click)="setActiveTab('proiezione')"
      >
        Proiezione
      </button>
    </nav>

    <!-- Tab Panels -->
    <div class="flex-1 overflow-y-auto">
      <!-- Cedolino Panel -->
      @if (activeTab() === 'cedolino') {
        <div id="panel-cedolino" role="tabpanel" aria-labelledby="tab-cedolino">
          <!-- Riepilogo Generale -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              Riepilogo
            </h3>
            <dl>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">RAL (Lordo Annuo)</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.ral) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">Totale Trattenute</dt>
                <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.totaleTrattenute) }}
                </dd>
              </div>
              <div class="flex justify-between py-1.5">
                <dt class="text-sm text-stone-600 dark:text-stone-400">Totale Bonus</dt>
                <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                  + {{ formatCurrency(r.totaleBonus) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-2 mt-2 border-t border-stone-300 font-semibold dark:border-stone-600"
              >
                <dt class="text-sm text-stone-800 dark:text-stone-200">Netto Annuo</dt>
                <dd class="text-sm text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.nettoAnnuo) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">Aliquota Effettiva</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatPercent(r.aliquotaEffettiva) }}
                </dd>
              </div>
              <div class="flex justify-between py-1.5">
                <dt class="text-sm text-stone-600 dark:text-stone-400">Totale Percepito</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.totalePercepito) }}
                </dd>
              </div>
            </dl>
          </section>

          <!-- Contributi INPS -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              Contributi INPS
            </h3>
            <dl>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">Imponibile Previdenziale</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.contributiInps.imponibilePrevidenziale) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">Aliquota Applicata</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatPercent(r.contributiInps.aliquotaApplicata) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-1.5"
                [class.border-b]="r.contributiInps.contributoAggiuntivo > 0"
                [class.border-dotted]="r.contributiInps.contributoAggiuntivo > 0"
                [class.border-stone-100]="r.contributiInps.contributoAggiuntivo > 0"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">Contributi Base</dt>
                <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.contributiInps.contributiBase) }}
                </dd>
              </div>
              @if (r.contributiInps.contributoAggiuntivo > 0) {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Contributo Aggiuntivo 1%
                  </dt>
                  <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                    - {{ formatCurrency(r.contributiInps.contributoAggiuntivo) }}
                  </dd>
                </div>
              }
              <div
                class="flex justify-between py-2 mt-2 border-t border-stone-300 font-semibold dark:border-stone-600"
              >
                <dt class="text-sm text-stone-800 dark:text-stone-200">Totale Contributi</dt>
                <dd class="text-sm text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.contributiInps.totaleContributi) }}
                </dd>
              </div>
            </dl>
          </section>

          <!-- Regime Impatriati -->
          @if (r.regimeImpatriati) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Regime Impatriati
              </h3>
              <dl>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Esenzione Applicata</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatPercent(r.regimeImpatriati.percentualeEsenzione) }}
                    {{ r.regimeImpatriati.haFigliMinorenni ? '(figli minorenni)' : '(standard)' }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Reddito Agevolabile</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.regimeImpatriati.redditoAgevolabile) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Importo Esente IRPEF</dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    {{ formatCurrency(r.regimeImpatriati.importoEsente) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">
                    (riduce imponibile IRPEF e addizionali, non INPS)
                  </dt>
                </div>
              </dl>
            </section>
          }

          <!-- IRPEF -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              IRPEF
            </h3>
            <dl>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">Imponibile IRPEF</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.irpef.imponibileIrpef) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">IRPEF Lorda</dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.irpef.irpefLorda) }}
                </dd>
              </div>

              <!-- Dettaglio Scaglioni -->
              <div class="my-2 pl-3 border-l-2 border-stone-200 dark:border-stone-600">
                <h4 class="text-xs font-semibold text-stone-500 mb-2 dark:text-stone-400">
                  Dettaglio Scaglioni
                </h4>
                @for (scaglione of r.irpef.dettaglioScaglioni; track scaglione.scaglione) {
                  @if (scaglione.imponibileScaglione > 0) {
                    <div class="flex justify-between py-1">
                      <dt class="text-xs text-stone-500 dark:text-stone-400">
                        Scaglione {{ scaglione.scaglione }} ({{
                          formatPercent(scaglione.aliquota)
                        }})
                      </dt>
                      <dd class="text-xs text-stone-500 dark:text-stone-400">
                        {{ formatCurrency(scaglione.impostaScaglione) }}
                      </dd>
                    </div>
                  }
                }
              </div>
            </dl>
          </section>

          <!-- Detrazioni -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              Detrazioni
            </h3>
            <dl>
              <!-- Detrazioni Lavoro -->
              @if (r.detrazioniLavoro.detrazioneEffettiva > 0) {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Detrazioni Lavoro Dipendente
                  </dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.detrazioniLavoro.detrazioneEffettiva) }}
                  </dd>
                </div>
                @if (r.detrazioniLavoro.maggiorazione > 0) {
                  <div class="flex justify-between py-1 pl-3">
                    <dt class="text-xs text-stone-500 dark:text-stone-400">
                      di cui maggiorazione €65
                    </dt>
                    <dd class="text-xs text-stone-500 dark:text-stone-400">
                      {{ formatCurrency(r.detrazioniLavoro.maggiorazione) }}
                    </dd>
                  </div>
                }
              }

              <!-- Detrazioni Familiari -->
              @if (r.detrazioniFamiliari.totaleDetrazioniFamiliari > 0) {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Detrazioni Familiari</dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.detrazioniFamiliari.totaleDetrazioniFamiliari) }}
                  </dd>
                </div>
                @if (r.detrazioniFamiliari.detrazioneConiuge > 0) {
                  <div class="flex justify-between py-1 pl-3">
                    <dt class="text-xs text-stone-500 dark:text-stone-400">Coniuge</dt>
                    <dd class="text-xs text-stone-500 dark:text-stone-400">
                      {{ formatCurrency(r.detrazioniFamiliari.detrazioneConiuge) }}
                    </dd>
                  </div>
                }
                @if (r.detrazioniFamiliari.detrazioneFigli > 0) {
                  <div class="flex justify-between py-1 pl-3">
                    <dt class="text-xs text-stone-500 dark:text-stone-400">
                      Figli ({{ r.detrazioniFamiliari.numeroFigliConDetrazione }})
                    </dt>
                    <dd class="text-xs text-stone-500 dark:text-stone-400">
                      {{ formatCurrency(r.detrazioniFamiliari.detrazioneFigli) }}
                    </dd>
                  </div>
                }
                @if (r.detrazioniFamiliari.detrazioneAscendenti > 0) {
                  <div class="flex justify-between py-1 pl-3">
                    <dt class="text-xs text-stone-500 dark:text-stone-400">
                      Ascendenti ({{ r.detrazioniFamiliari.numeroAscendentiConDetrazione }})
                    </dt>
                    <dd class="text-xs text-stone-500 dark:text-stone-400">
                      {{ formatCurrency(r.detrazioniFamiliari.detrazioneAscendenti) }}
                    </dd>
                  </div>
                }
              }

              <!-- Cuneo Fiscale -->
              @if (r.cuneoFiscale.indennitaEsente > 0) {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Indennità Cuneo Fiscale (esente)
                  </dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.cuneoFiscale.indennitaEsente) }}
                  </dd>
                </div>
              }
              @if (r.cuneoFiscale.detrazioneAggiuntiva > 0) {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Detrazione Cuneo Fiscale
                  </dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.cuneoFiscale.detrazioneAggiuntiva) }}
                  </dd>
                </div>
              }

              <!-- Altre Detrazioni -->
              @if (r.riepilogoDetrazioni.altre > 0) {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Altre Detrazioni</dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.riepilogoDetrazioni.altre) }}
                  </dd>
                </div>
              }

              <div
                class="flex justify-between py-2 mt-2 border-t border-stone-300 font-semibold dark:border-stone-600"
              >
                <dt class="text-sm text-stone-800 dark:text-stone-200">Totale Detrazioni</dt>
                <dd class="text-sm text-green-600 dark:text-green-400">
                  + {{ formatCurrency(r.riepilogoDetrazioni.totale) }}
                </dd>
              </div>
            </dl>
          </section>

          <!-- Trattamento Integrativo -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              Trattamento Integrativo
            </h3>
            <dl>
              @if (r.trattamentoIntegrativo.spetta) {
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Importo Spettante</dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.trattamentoIntegrativo.importo) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">Importo</dt>
                  <dd class="text-xs text-stone-500 dark:text-stone-400">
                    {{ r.trattamentoIntegrativo.importoPieno ? 'Pieno' : 'Ridotto' }}
                  </dd>
                </div>
              } @else {
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Non spetta</dt>
                  <dd class="text-sm text-stone-500">
                    {{ r.trattamentoIntegrativo.motivoNonSpettanza || '-' }}
                  </dd>
                </div>
              }
            </dl>
          </section>

          <!-- IRPEF Netta e Finale -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              IRPEF Finale
            </h3>
            <dl>
              <div class="flex justify-between py-1.5">
                <dt class="text-sm text-stone-600 dark:text-stone-400">
                  IRPEF Netta (dopo detrazioni)
                </dt>
                <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                  {{ formatCurrency(r.irpefNetta) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-2 mt-2 border-t border-stone-300 font-semibold dark:border-stone-600"
              >
                <dt class="text-sm text-stone-800 dark:text-stone-200">IRPEF Finale</dt>
                <dd class="text-sm text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.irpefFinale) }}
                </dd>
              </div>
            </dl>
          </section>

          <!-- Addizionali -->
          <section class="p-4 border-b border-stone-100 dark:border-stone-700">
            <h3
              class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
            >
              Addizionali
            </h3>
            <dl>
              <div
                class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">
                  Addizionale Regionale ({{ formatPercent(r.addizionali.aliquotaRegionale) }})
                </dt>
                <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.addizionali.addizionaleRegionale) }}
                </dd>
              </div>
              <div
                class="flex justify-between py-1.5"
                [class.border-b]="r.addizionali.esenzioneComunaleApplicata"
                [class.border-dotted]="r.addizionali.esenzioneComunaleApplicata"
                [class.border-stone-100]="r.addizionali.esenzioneComunaleApplicata"
              >
                <dt class="text-sm text-stone-600 dark:text-stone-400">
                  Addizionale Comunale ({{ formatPercent(r.addizionali.aliquotaComunale) }})
                </dt>
                <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.addizionali.addizionaleComunale) }}
                </dd>
              </div>
              @if (r.addizionali.esenzioneComunaleApplicata) {
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">
                    Esenzione comunale applicata
                  </dt>
                  <dd class="text-xs text-stone-500 dark:text-stone-400">Sì</dd>
                </div>
              }
              <div
                class="flex justify-between py-2 mt-2 border-t border-stone-300 font-semibold dark:border-stone-600"
              >
                <dt class="text-sm text-stone-800 dark:text-stone-200">Totale Addizionali</dt>
                <dd class="text-sm text-red-600 dark:text-red-400">
                  - {{ formatCurrency(r.addizionali.totaleAddizionali) }}
                </dd>
              </div>
            </dl>
          </section>

          <!-- Fondo Mario Negri -->
          @if (r.fondoNegri) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Fondo Mario Negri
              </h3>
              <dl>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Annuo</dt>
                  <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                    - {{ formatCurrency(r.fondoNegri.contributoAnnuo) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Mensile</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fondoNegri.contributoMensile) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Risparmio Fiscale Stimato
                  </dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.fondoNegri.risparmoFiscaleStimato) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">
                    (riduzione imponibile IRPEF)
                  </dt>
                </div>
              </dl>
            </section>
          }

          <!-- Fondo Antonio Pastore -->
          @if (r.fondoPastore) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Fondo Antonio Pastore
              </h3>
              <dl>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Annuo</dt>
                  <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                    - {{ formatCurrency(r.fondoPastore.contributoAnnuo) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Mensile</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fondoPastore.contributoMensile) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">
                    (trattenuta diretta dal netto, non deducibile)
                  </dt>
                </div>
              </dl>
            </section>
          }

          <!-- CFMT -->
          @if (r.cfmt) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                CFMT
              </h3>
              <dl>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Annuo</dt>
                  <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                    - {{ formatCurrency(r.cfmt.contributoAnnuo) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Mensile</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.cfmt.contributoMensile) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">
                    (trattenuta diretta dal netto, non deducibile)
                  </dt>
                </div>
              </dl>
            </section>
          }

          <!-- Fondo Pensione Integrativo -->
          @if (r.fondoPensioneIntegrativo) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Previdenza Complementare
              </h3>
              <dl>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Contributo Lavoratore (annuo)
                  </dt>
                  <dd class="text-sm font-medium text-red-600 dark:text-red-400">
                    - {{ formatCurrency(r.fondoPensioneIntegrativo.contributoLavoratoreAnnuo) }}
                  </dd>
                </div>
                @if (r.fondoPensioneIntegrativo.contributoDatoreLavoroAnnuo > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Contributo Datore (annuo)
                    </dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.fondoPensioneIntegrativo.contributoDatoreLavoroAnnuo) }}
                    </dd>
                  </div>
                }
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Contributo Mensile</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fondoPensioneIntegrativo.contributoLavoratoreMensile) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Deduzione Effettiva</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fondoPensioneIntegrativo.deduzioneEffettiva) }}
                  </dd>
                </div>
                @if (r.fondoPensioneIntegrativo.eccedenzaNonDeducibile > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Eccedenza Non Deducibile
                    </dt>
                    <dd class="text-sm font-medium text-stone-500 dark:text-stone-400">
                      {{ formatCurrency(r.fondoPensioneIntegrativo.eccedenzaNonDeducibile) }}
                    </dd>
                  </div>
                }
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">
                    Risparmio Fiscale Stimato
                  </dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.fondoPensioneIntegrativo.risparmoFiscaleStimato) }}
                  </dd>
                </div>
                <div class="flex justify-between py-1 pl-3">
                  <dt class="text-xs text-stone-500 dark:text-stone-400">
                    (deduzione imponibile IRPEF, max 5.300 euro/anno)
                  </dt>
                </div>
              </dl>
            </section>
          }

          <!-- Fringe Benefit -->
          @if (r.fringeBenefit.valoreTotaleLordo > 0) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Fringe Benefit
              </h3>
              <dl>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Valore Totale Lordo</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fringeBenefit.valoreTotaleLordo) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Soglia Esenzione</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fringeBenefit.sogliaEsenzione) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Soglia Superata</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ r.fringeBenefit.sogliaSuperata ? 'Sì' : 'No' }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Valore Imponibile</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fringeBenefit.valoreImponibile) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Valore Esente</dt>
                  <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.fringeBenefit.valoreEsente) }}
                  </dd>
                </div>
                @if (r.fringeBenefit.autoAziendale) {
                  <div class="my-2 pl-3 border-l-2 border-stone-200 dark:border-stone-600">
                    <h4 class="text-xs font-semibold text-stone-500 mb-2 dark:text-stone-400">
                      Auto Aziendale
                    </h4>
                    <div class="flex justify-between py-1">
                      <dt class="text-xs text-stone-500 dark:text-stone-400">Valore</dt>
                      <dd class="text-xs text-stone-500 dark:text-stone-400">
                        {{ formatCurrency(r.fringeBenefit.autoAziendale.valore) }}
                      </dd>
                    </div>
                    <div class="flex justify-between py-1">
                      <dt class="text-xs text-stone-500 dark:text-stone-400">
                        Percentuale Applicata
                      </dt>
                      <dd class="text-xs text-stone-500 dark:text-stone-400">
                        {{ formatPercent(r.fringeBenefit.autoAziendale.percentualeApplicata) }}
                      </dd>
                    </div>
                    <div class="flex justify-between py-1">
                      <dt class="text-xs text-stone-500 dark:text-stone-400">Mesi Utilizzo</dt>
                      <dd class="text-xs text-stone-500 dark:text-stone-400">
                        {{ r.fringeBenefit.autoAziendale.mesiUtilizzo }}
                      </dd>
                    </div>
                    @if (r.fringeBenefit.trattenutaAutoDipendente > 0) {
                      <div class="flex justify-between py-1">
                        <dt class="text-xs text-stone-500 dark:text-stone-400">
                          Trattenuta Dipendente
                        </dt>
                        <dd class="text-xs text-stone-500 dark:text-stone-400">
                          -{{ formatCurrency(r.fringeBenefit.trattenutaAutoDipendente) }}
                        </dd>
                      </div>
                    }
                  </div>
                }
              </dl>
            </section>
          }

          <!-- Rimborsi Trasferta -->
          @if (r.rimborsiTrasferta.totaleRimborsi > 0) {
            <section class="p-4 border-b border-stone-100 dark:border-stone-700">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Rimborsi Trasferta
              </h3>
              <dl>
                @if (r.rimborsiTrasferta.rimborsoForfettarioEsente > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Rimborso Forfettario (esente)
                    </dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.rimborsiTrasferta.rimborsoForfettarioEsente) }}
                    </dd>
                  </div>
                }
                @if (r.rimborsiTrasferta.rimborsoDocumentatoEsente > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Rimborso Documentato (esente)
                    </dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.rimborsiTrasferta.rimborsoDocumentatoEsente) }}
                    </dd>
                  </div>
                }
                @if (r.rimborsiTrasferta.rimborsiTassati > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">Rimborsi Tassati</dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.rimborsiTrasferta.rimborsiTassati) }}
                    </dd>
                  </div>
                }
                <div class="flex justify-between py-1.5">
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Totale Esente</dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.rimborsiTrasferta.totaleEsente) }}
                  </dd>
                </div>
                <div
                  class="flex justify-between py-2 mt-2 border-t border-stone-300 font-semibold dark:border-stone-600"
                >
                  <dt class="text-sm text-stone-800 dark:text-stone-200">Totale Rimborsi</dt>
                  <dd class="text-sm text-stone-900 dark:text-stone-100">
                    {{ formatCurrency(r.rimborsiTrasferta.totaleRimborsi) }}
                  </dd>
                </div>
              </dl>
            </section>
          }

          <!-- Benefit Non Tassati -->
          @if (r.benefitNonTassati.totaleEsente > 0 || r.benefitNonTassati.totaleTassato > 0) {
            <section class="p-4">
              <h3
                class="text-sm font-semibold text-stone-800 border-b border-stone-200 pb-2 mb-3 dark:text-stone-200 dark:border-stone-600"
              >
                Benefit Non Tassati (Welfare)
              </h3>
              <dl>
                @if (r.benefitNonTassati.previdenzaComplementare > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Previdenza Complementare
                    </dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.benefitNonTassati.previdenzaComplementare) }}
                    </dd>
                  </div>
                }
                @if (r.benefitNonTassati.assistenzaSanitaria > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">Assistenza Sanitaria</dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.benefitNonTassati.assistenzaSanitaria) }}
                    </dd>
                  </div>
                }
                @if (r.benefitNonTassati.buoniPastoEsenti > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">Buoni Pasto (esenti)</dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.benefitNonTassati.buoniPastoEsenti) }}
                    </dd>
                  </div>
                }
                @if (r.benefitNonTassati.buoniPastoTassati > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Buoni Pasto (tassati)
                    </dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.benefitNonTassati.buoniPastoTassati) }}
                    </dd>
                  </div>
                }
                @if (r.benefitNonTassati.altriWelfare > 0) {
                  <div
                    class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                  >
                    <dt class="text-sm text-stone-600 dark:text-stone-400">Altri Welfare</dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.benefitNonTassati.altriWelfare) }}
                    </dd>
                  </div>
                }
                <div
                  class="flex justify-between py-1.5 border-b border-dotted border-stone-100 dark:border-stone-700"
                >
                  <dt class="text-sm text-stone-600 dark:text-stone-400">Totale Esente</dt>
                  <dd class="text-sm font-medium text-green-600 dark:text-green-400">
                    + {{ formatCurrency(r.benefitNonTassati.totaleEsente) }}
                  </dd>
                </div>
                @if (r.benefitNonTassati.totaleTassato > 0) {
                  <div class="flex justify-between py-1.5">
                    <dt class="text-sm text-stone-600 dark:text-stone-400">
                      Totale Tassato (eccedenze)
                    </dt>
                    <dd class="text-sm font-medium text-stone-900 dark:text-stone-100">
                      {{ formatCurrency(r.benefitNonTassati.totaleTassato) }}
                    </dd>
                  </div>
                }
              </dl>
            </section>
          }
        </div>
      }

      <!-- Flusso Panel -->
      @if (activeTab() === 'flusso') {
        <div
          id="panel-flusso"
          role="tabpanel"
          aria-labelledby="tab-flusso"
          class="h-[500px] px-2 pb-2"
        >
          <app-graph-funnel [result]="result()" />
        </div>
      }

      <!-- Proiezione Panel -->
      @if (activeTab() === 'proiezione') {
        <div
          id="panel-proiezione"
          role="tabpanel"
          aria-labelledby="tab-proiezione"
          class="h-[500px] px-2 pb-2"
        >
          <app-graph-projection [result]="result()" [baseInput]="baseInput()" />
        </div>
      }
    </div>
  } @else {
    <div class="p-8 text-center">
      <p class="text-stone-500 mb-2 dark:text-stone-400">
        Compila il form per calcolare il tuo stipendio netto.
      </p>
      <p class="text-sm text-stone-400 dark:text-stone-500">
        I campi obbligatori sono: RAL, Regione e Comune.
      </p>
    </div>
  }
</aside>
